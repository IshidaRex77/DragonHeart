jQuery(document).ready(function($){
    $.ajaxSetup({
		type: 'post',
		url: App.base_url+"ajax_helper.php",
		headers : {
            'token': $('meta[name="token"]').attr('content'),
            'is_ajax': 1
        },
		dataType: "json",
		error: function (jqXHR, exception) {
			if(jqXHR.status == 404) {
				alert('Requested page not found. [404]');
			} else if(jqXHR.status == 500) {
				alert('Internal Server Error [500]');
			} else if(jqXHR.status == '429') {
			    alert('Refresh page and try again! [429]');
		    } else if(exception === 'parsererror') {
				alert(jqXHR.responseText);
			} else if(exception === 'timeout') {
				alert('Time out error');
			} else if(exception === 'abort') {
				alert('Ajax request aborted.');
			} else {
			    alert('error = '+exception);
			}
		}
	});
    $(document).on('submit', '#registerForm', function(e) {
        e.preventDefault();
        var form = $(this);
        $.ajax({
			data: $.param({'action' : 'create_account'}) + '&' + $(form).serialize(),
			beforeSend: function() {
				$(".alert").remove();
				$("<div class='alert alert-info' id='alert'>Please Wait...</div>").hide().fadeIn(1500).insertBefore(form);
			},
			success: function(data){
				if(data.error){
				    $(".alert").remove();
                    Swal.fire("Error!", data.error, "error");
				}
				else{
				    $(".alert").remove();
                    Swal.fire({
                        title: "Success!",
                        text: data.success,
                        icon: "success"
                    }).then(function() {
                        location.reload();
                    });
				}
			}
		});
    });
    $(document).on('submit', '#recoverPassword', function(e) {
        e.preventDefault();
        var form = $(this);
        $.ajax({
			data: $.param({'action' : 'recover_password', 'sub_action': 'step_1'}) + '&' + $(form).serialize(),
			beforeSend: function() {
				$(".alert").remove();
				$("<div class='alert alert-info' id='alert'>Please Wait...</div>").hide().fadeIn(1500).insertBefore(form);
			},
			success: function(data){
				if(data.error){
				    $(".alert").remove();
                    Swal.fire("Error!", data.error, "error");
				}
				else{
				    $(".alert").remove();
                    Swal.fire({
                        title: "Success!",
                        text: data.success,
                        icon: "success"
                    }).then(function() {
                        location.reload();
                    });
				}
			}
		});
    });
    $(document).on('submit', '#recoverPasswordStep2', function(e) {
        e.preventDefault();
        var form = $(this);
        $.ajax({
			data: $.param({'action' : 'recover_password', 'sub_action': 'step_2'}) + '&' + $(form).serialize(),
			beforeSend: function() {
				$(".alert").remove();
				$("<div class='alert alert-info' id='alert'>Please Wait...</div>").hide().fadeIn(1500).insertBefore(form);
			},
			success: function(data){
				if(data.error){
				    $(".alert").remove();
                    Swal.fire("Error!", data.error, "error");
				}
				else{
				    $(".alert").remove();
                    Swal.fire({
                        title: "Success!",
                        text: data.success,
                        icon: "success"
                    }).then(function() {
                        location.reload();
                    });
				}
			}
		});
    });
    $(document).on('submit', '#accPassword', function(e) {
        e.preventDefault();
        var form = $(this);
        $.ajax({
			data: $.param({'action' : 'change_password'}) + '&' + $(form).serialize(),
			beforeSend: function() {
				$(".alert").remove();
				$("<div class='alert alert-info' id='alert'>Please Wait...</div>").hide().fadeIn(1500).insertBefore(form);
			},
			success: function(data){
				if(data.error){
				    $(".alert").remove();
                    Swal.fire("Error!", data.error, "error");
				}
				else{
				    $(".alert").remove();
                    Swal.fire({
                        title: "Success!",
                        text: data.success,
                        icon: "success"
                    }).then(function() {
                        location.reload();
                    });
				}
			}
		});
    });
    $(document).on('submit', '#changeEmail', function(e) {
        e.preventDefault();
        var form = $(this);
        $.ajax({
			data: $.param({'action' : 'change_email'}) + '&' + $(form).serialize(),
			beforeSend: function() {
				$(".alert").remove();
				$("<div class='alert alert-info' id='alert'>Please Wait...</div>").hide().fadeIn(1500).insertBefore(form);
			},
			success: function(data){
				if(data.error){
				    $(".alert").remove();
                    Swal.fire("Error!", data.error, "error");
				}
				else{
				    $(".alert").remove();
                    Swal.fire({
                        title: "Success!",
                        text: data.success,
                        icon: "success"
                    }).then(function() {
                        location.reload();
                    });
				}
			}
		});
    });
    $(document).on('click', '#recoverKey', function(e) {
        e.preventDefault();
        var parent = $(this);
        $.ajax({
			data: $.param({'action' : 'recover_key'}),
			beforeSend: function() {
				$(".alert").remove();
				$("<div class='alert alert-info' id='alert'>Please Wait...</div>").hide().fadeIn(1500).insertBefore(parent);
			},
			success: function(data){
				if(data.error){
				    $(".alert").remove();
                    Swal.fire("Error!", data.error, "error");
				}
				else{
				    $(".alert").remove();
                    Swal.fire({
                        title: "Success!",
                        text: data.success,
                        icon: "success"
                    }).then(function() {
                        location.reload();
                    });
				}
			}
		});
    });
	$(document).on('submit', '#loginForm', function(e) {
        e.preventDefault();
        var form = $(this);
        $.ajax({
			data: $.param({'action' : 'login'}) + '&' + $(form).serialize(),
			beforeSend: function() {
				$(".alert").remove();
				$("<div class='alert alert-info' id='alert'>Please Wait...</div>").hide().fadeIn(1500).insertBefore(form);
			},
			success: function(data){
				if(data.error){
				    $(".alert").remove();
                    Swal.fire("Error!", data.error, "error");
				}
				else{
				    $(".alert").remove();
                    Swal.fire({
                        title: "Success!",
                        text: data.success,
                        icon: "success"
                    }).then(function() {
                        location.reload();
                    });
				}
			}
		});
    });
	$('a[id^="vote-"]').on('click', function(e){
		e.preventDefault();
		var parent = $(this);
		var id = $(this).attr('id').split("-")[1];
		let character = parseInt($('select#character-'+id).find('option:selected').val());
		if($(this).attr('data-info') == 'voted'){
			alert('You have voted for this link!');
		} else if(character == '') {
			alert('Select a character first!');
			return;
		}
		else if($(this).attr('data-status') == 'cant_vote'){
			alert('You currently cant vote!');
		} else if(!navigator.cookieEnabled) {
		    alert('You do not meet the requirements to use this module at this time. Please try again later. Code 0x998');
		}
		else{
			if($(this).attr('data-pingback') == 1){
				$.ajax({
				  data: $.param({'action' : 'vote', 'vote_id' : id, 'character': character, 'postback': 1}),
				  success: function(data){
					if(data.error){
						Swal.fire("Error!", data.error, "error");
					}
					else{
						window.open($(parent).attr('data-link'), '_blank');
						$('a[id="vote-'+id+'"]').html('Reward will added after vote pingback result!');
						return;
					}
				  }
				});
			} else {
				window.open($(this).attr('data-link'), '_blank');
				$('a[id^="vote-"]').each(function(){
					$(this).attr('data-status', 'cant_vote');
				});
				$('a[id="vote-'+id+'"]').html('Voting..');
				setTimeout(function(){
					$.ajax({
					  data: $.param({'action' : 'vote', 'vote_id' : id, 'character': character}),
					  success: function(data){
						if(data.error){
							if(!alert(data.error)) window.location.reload();
						}
						else{
							$('a[id="vote-'+id+'"]').replaceWith(data.next_vote);
							$('a[id^="vote-"]').each(function(){
								$(this).attr('data-status','can_vote');
							});
							if(!alert(data.success)) window.location.reload();
						}
					  }
					});
				}, parseInt(App.vote_counter * 1000));
			}
		}
	});
	$('a[id^="paypal-package-"]').on('click', function(e){
		e.preventDefault();
		var id = $(this).attr('id').split("-")[2];
		let character = parseInt($('select#character-'+id).find('option:selected').val());
		$.ajax({
			data: $.param({'action' : 'add_paypal_order', 'package_id' : id, 'character': character}),
			success: function(data){
				if(data.error){
					alert(data.error);
				}
				else{
					var form = '<form action="https://www.paypal.com/cgi-bin/webscr" method="post">';
					form += '<input type="hidden" name="cmd" value="_donations" />';
					form += '<input type="hidden" name="rm" value="2" />';
					form += '<input type="hidden" name="business" value="'+data.email+'" />';
					form += '<input type="hidden" name="item_name" value="Donate for '+$('title').html()+'" />';
					form += '<input type="hidden" name="item_number" value="'+data.item_number+'" />';
					form += '<input type="hidden" name="currency_code" value="'+data.currency_code+'" />';
					form += '<input type="hidden" name="amount" value="'+data.amount+'" />';
					form += '<input type="hidden" name="no_shipping" value="1" />';
					form += '<input type="hidden" name="shipping" value="0.00" />';
					form += '<input type="hidden" name="return" value="'+App.base_url+'" />';
					form += '<input type="hidden" name="cancel_return" value="'+App.base_url+'" />';
					form += '<input type="hidden" name="notify_url" value="'+App.base_url+'paypal.php" />';
					form += '<input type="hidden" name="custom" value="'+data.username+'" />';
					form += '<input type="hidden" name="no_note" value="1" />';
					form += '<input type="hidden" name="tax" value="0.00" />';
					form += '<input type="submit" value="Donate" />';
					form += '</form>';
					$(form).appendTo('body').submit();
				}
			}
		});
	});
	$('button[id^="claim-stage-"]').on('click', function(e){
		e.preventDefault();
		var id = $(this).attr('id').split("-")[2];
		let character = parseInt($('select#character-'+id).find('option:selected').val());
		$.ajax({
			data: $.param({'action' : 'claim_stage', 'stage_id' : id, 'character': character}),
			success: function(data){
				if(data.error){
				    $(".alert").remove();
                    Swal.fire("Error!", data.error, "error");
				}
				else{
				    $(".alert").remove();
                    Swal.fire({
                        title: "Success!",
                        text: data.success,
                        icon: "success"
                    }).then(function() {
                        location.reload();
                    });
				}
			}
		});
	});
});